#!/command/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Spotify Connect
# Runs librespot
# ==============================================================================
declare -a options
declare bitrate
declare name
declare oauth_enabled
declare autoplay
declare initial_volume

bashio::log.info 'Starting the Spotify daemon...'

# Bitrate
options+=(--bitrate $(bashio::config 'bitrate'))

# Initial Volume
initial_volume=$(bashio::config 'initial_volume')
options+=(--initial-volume "$initial_volume")

# Device name
name=$(bashio::config 'name')
options+=(--name "${name}")
options+=(--zeroconf-interface "0.0.0.0,::")
options+=(--zeroconf-backend "libmdns")

if bashio::config.true 'oauth_enabled'; then
    # Используем --backend-settings для передачи токена librespot
    # librespot использует refresh token для получения access token
    # Формат: --backend-settings spotify_token:REFRESH_TOKEN
    options+=(--enable-oauth)
    options+=(--oauth-port 5588)
    options+=(--cache "/data/")

    
    bashio::log.info 'Using OAuth for authentication.'
fi

# Autoplay
if bashio::config.true 'autoplay'; then
  options+=(--autoplay on)
fi

# Save writes
options+=(--disable-audio-cache)

# Are we running in debug mode?
if bashio::debug; then
  options+=(--verbose)
fi

# Run librespot
exec librespot "${options[@]}"
